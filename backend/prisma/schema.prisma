generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* =====================================================
   SISTEMA
===================================================== */

model Sistema {
  id      Int     @id @default(autoincrement())
  nome    String  @unique
  logoUrl String?
  ativo   Boolean @default(true)

  // Relacionamento muitos-para-muitos com ERPs
  erps Erp[] @relation("SistemaErps")
}

/* =====================================================
   ERP (DONO DAS REGRAS E PAR√ÇMETROS)
===================================================== */

model Erp {
  id    Int     @id @default(autoincrement())
  nome  String  @unique
  ativo Boolean @default(true)

  // Relacionamento muitos-para-muitos com Sistemas
  sistemas Sistema[] @relation("SistemaErps")

  // Relacionamentos existentes
  documentacoes Documentacao[]
  servicos      Servico[]

  // üÜï Complementos (N√ÉO QUEBRAM NADA)
  empresas   Empresa[]
  parametros Parametro[]
  regras     RegraNegocio[]
}

/* =====================================================
   DOCUMENTA√á√ÉO
===================================================== */

model Documentacao {
  id               Int      @id @default(autoincrement())
  nome_empresa     String
  nome_contratante String
  documentado_por  String
  data             DateTime
  numero_contrato  String?
  info_adicionais  String?
  createdAt        DateTime @default(now())

  // RELACIONAMENTO COM ERP 
  erpId Int?
  erp   Erp? @relation(fields: [erpId], references: [id])

  servicos          Servico[]
  servicosDesejados ServicoDesejado[]
}

/* =====================================================
   SERVI√áO
===================================================== */

model Servico {
  id Int @id @default(autoincrement())

  // üîó Nome do servi√ßo (cat√°logo)
  nomeServicoId Int
  nomeServico   NomeServico @relation(fields: [nomeServicoId], references: [id])

  // üìÑ Dados do servi√ßo
  descricao  String?
  instrucoes String?
  ativo      Boolean @default(true)

  // üÜï Desativa√ß√£o
  motivoDesativacao String?
  dataDesativacao   DateTime?

  sem_necessidade_api Boolean  @default(false)
  endpoint            String?
  parametros_padrao   Json?
  exige_contrato      Boolean  @default(false)
  exige_cpf_cnpj      Boolean  @default(false)
  exige_login_ativo   Boolean  @default(false)
  responsavel_padrao  String?
  createdAt           DateTime @default(now())

  // üîó Documenta√ß√£o
  documentacaoId Int
  documentacao   Documentacao @relation(fields: [documentacaoId], references: [id])

  // üîó ERP
  erpId Int
  erp   Erp @relation(fields: [erpId], references: [id])
}

/* =====================================================
   SERVI√áO DESEJADO
===================================================== */

model ServicoDesejado {
  id        Int      @id @default(autoincrement())
  descricao String?
  createdAt DateTime @default(now())

  documentacaoId Int
  documentacao   Documentacao @relation(fields: [documentacaoId], references: [id])
}

/* =====================================================
   NOME DO SERVI√áO
===================================================== */

model NomeServico {
  id   Int    @id @default(autoincrement())
  nome String @unique

  servicos Servico[]
}

/* =====================================================
   EMPRESA
===================================================== */

model Empresa {
  id       Int     @id @default(autoincrement())
  nome     String  @unique
  cpf_cnpj String? @unique

  // üîó ERP ao qual a empresa pertence
  erpId Int
  erp   Erp @relation(fields: [erpId], references: [id])

  // üîó Regras aplicadas
  regras EmpresaRegra[]
}

/* =====================================================
   PAR√ÇMETRO (CRIADO NA TELA DE PAR√ÇMETROS)
===================================================== */

model Parametro {
  id     Int    @id @default(autoincrement())
  codigo String
  nome   String
  ativo  Boolean @default(true)

  // üîó ERP ao qual pertence
  erpId Int
  erp   Erp @relation(fields: [erpId], references: [id])

  // üîó Uso nas regras
  regrasComoPadrao     RegraNegocio[]
  regrasComoNecessario RegraParametroNecessario[]

  @@unique([codigo, erpId])
}

/* =====================================================
   REGRA DE NEG√ìCIO
===================================================== */

model RegraNegocio {
  id Int @id @default(autoincrement())

  // ‚ö†Ô∏è CAMPOS LEGADOS (MANTIDOS PARA N√ÉO QUEBRAR)
  parametros_padrao       String
  parametros_obrigatorios String

  // üß† NOVOS CAMPOS
  codigo    String
  descricao String
  ativa     Boolean @default(true)

  // üîó ERP dono da regra
  erpId Int
  erp   Erp @relation(fields: [erpId], references: [id])

  // üîë Par√¢metro padr√£o (gatilho da regra)
  parametroPadraoId Int
  parametroPadrao   Parametro @relation(fields: [parametroPadraoId], references: [id])

  // üîë Par√¢metros necess√°rios
  parametrosNecessarios RegraParametroNecessario[]

  // üîó Empresas que usam a regra
  empresas EmpresaRegra[]

  @@unique([codigo, erpId])
}

/* =====================================================
   PAR√ÇMETROS NECESS√ÅRIOS DA REGRA
===================================================== */

model RegraParametroNecessario {
  id Int @id @default(autoincrement())

  regraId     Int
  parametroId Int

  regra     RegraNegocio @relation(fields: [regraId], references: [id])
  parametro Parametro   @relation(fields: [parametroId], references: [id])

  @@unique([regraId, parametroId])
}

/* =====================================================
   EMPRESA ‚áÑ REGRA (USO DA REGRA)
===================================================== */

model EmpresaRegra {
  id Int @id @default(autoincrement())

  empresaId Int
  regraId   Int

  empresa Empresa      @relation(fields: [empresaId], references: [id])
  regra   RegraNegocio @relation(fields: [regraId], references: [id])

  ativa Boolean @default(true)

  @@unique([empresaId, regraId])
}
